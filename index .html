<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Velor — Position Size Calculator (Auto FX)</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#f6fbff;
  --card:#fff;
  --muted:#6b7480;
  --accent:#07203a;
  --radius:12px;
  --gap:14px;
}
*{box-sizing:border-box}
body{margin:0;font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,Arial;background:var(--bg);color:var(--accent)}
.container{max-width:920px;margin:28px auto;padding:20px}
.header{display:flex;gap:12px;align-items:center;margin-bottom:18px}
.logo{width:64px;height:64px;border-radius:12px;overflow:hidden;background:linear-gradient(180deg,var(--accent),#0b3850);display:flex;align-items:center;justify-content:center}
.logo img{width:84%;height:84%;object-fit:contain}
.title{font-weight:700;font-size:18px}
.subtitle{font-size:13px;color:var(--muted);margin-top:4px}
.grid{display:grid;grid-template-columns:1fr 320px;gap:20px}
.card{background:var(--card);border-radius:var(--radius);padding:18px;box-shadow:0 10px 30px rgba(8,20,40,0.06)}
.field{margin-top:14px}
.label{font-size:13px;color:var(--muted);margin-bottom:8px}
.input, select{width:100%;padding:14px;border-radius:10px;border:1px solid #e6eef6;font-size:15px}
.row{display:flex;gap:14px}
.col{flex:1}
.cta{display:block;width:100%;padding:14px;border-radius:12px;background:var(--accent);color:white;font-weight:700;border:none;font-size:15px;margin-top:14px}
.result{margin-top:14px;padding:14px;border-radius:12px;background:#fbfcfd;border:1px solid #eaf2f7;font-weight:700}
.small{font-size:12px;color:var(--muted)}
.warn{color:#b00000;font-weight:700;margin-top:12px}
.settings-toggle{font-size:13px;color:var(--muted);margin-top:10px;cursor:pointer;text-decoration:underline}
.hidden{display:none}
.footer{font-size:12px;color:var(--muted);text-align:center;margin-top:12px}
@media(max-width:820px){.grid{grid-template-columns:1fr}}
</style>
</head>
<body>
<div class="container">
  <div class="header">
    <div class="logo"><img src="logo.png" alt="logo" /></div>
    <div>
      <div class="title">Velor — Position Size</div>
      <div class="subtitle">Mini lot base (10,000) · Auto FX rates · Real-world adjustments</div>
    </div>
  </div>

  <div class="grid">
    <div class="card">
      <div style="font-weight:700">Calculator</div>

      <div class="field">
        <div class="label">Instrument</div>
        <select id="instrument" class="input">
          <optgroup label="Forex — Majors">
            <option value="EURUSD">EUR / USD</option>
            <option value="GBPUSD">GBP / USD</option>
            <option value="AUDUSD">AUD / USD</option>
            <option value="NZDUSD">NZD / USD</option>
            <option value="USDJPY">USD / JPY</option>
            <option value="USDCAD">USD / CAD</option>
            <option value="USDCHF">USD / CHF</option>
          </optgroup>
          <optgroup label="Forex — Crosses">
            <option value="EURGBP">EUR / GBP</option>
            <option value="EURJPY">EUR / JPY</option>
            <option value="GBPJPY">GBP / JPY</option>
          </optgroup>
          <optgroup label="Metals">
            <option value="XAUUSD">Gold (XAU / USD)</option>
            <option value="XAGUSD">Silver (XAG / USD)</option>
          </optgroup>
          <optgroup label="Indices (CFD)">
            <option value="SPX500">S&P 500 (SPX500)</option>
            <option value="US30">Dow 30 (US30)</option>
            <option value="NAS100">Nasdaq 100 (NAS100)</option>
          </optgroup>
        </select>
      </div>

      <div class="row" style="margin-top:12px">
        <div class="col">
          <div class="label">Account balance</div>
          <input id="acct" type="number" class="input" placeholder="10000" />
        </div>
        <div class="col">
          <div class="label">Risk %</div>
          <input id="risk" type="number" class="input" placeholder="1.0" step="0.01" />
        </div>
      </div>

      <div class="field">
        <div class="label">Stop (pips / points)</div>
        <input id="pips" type="number" class="input" placeholder="50" step="0.1" />
      </div>

      <div class="row" style="margin-top:12px">
        <div class="col">
          <div class="label">Spread (pips) — optional</div>
          <input id="spread" type="number" class="input" placeholder="0" step="0.1" />
        </div>
        <div class="col">
          <div class="label">Slippage (pips) — optional</div>
          <input id="slippage" type="number" class="input" placeholder="0" step="0.1" />
        </div>
      </div>

      <div class="field" style="margin-top:12px">
        <div class="label">Account currency</div>
        <select id="acctCurrency" class="input">
          <option value="USD">USD (default)</option>
          <option value="EUR">EUR</option>
          <option value="GBP">GBP</option>
          <option value="ZAR">ZAR</option>
          <option value="OTHER">Other (enter rate)</option>
        </select>
      </div>

      <div class="field hidden" id="convWrap">
        <div class="label">Conversion rate (quote → account currency)</div>
        <input id="convRate" class="input" placeholder="1.00" />
        <div class="small" style="margin-top:8px">If auto rates fail or you prefer your broker's rate, enter it here.</div>
      </div>

      <div class="settings-toggle" id="settingsToggle">Developer settings</div>
      <div class="field hidden" id="settings">
        <div class="label">Apps Script URL (paste your web app URL)</div>
        <input id="appsUrl" class="input" placeholder="https://script.google.com/macros/s/XXXXX/exec" />
        <label style="display:block;margin-top:8px"><input id="saveToSheet" type="checkbox" /> Save this calculation to Google Sheet</label>
      </div>

      <button id="calcBtn" class="cta">Calculate</button>

      <div id="out" class="result"><div id="resultText">Enter values and press Calculate.</div></div>
      <div id="warn" class="warn" style="display:none">Warning: You are risking more than 5%.</div>

    </div>

    <div class="card" id="rightCard">
      <div style="font-weight:700;margin-bottom:8px">Notes</div>
      <div class="small">Auto FX rates are fetched live when account currency ≠ instrument quote currency. If fetching fails, enter the conversion rate manually.</div>
      <div class="small" style="margin-top:8px">Spread and slippage are added to the stop to model real-world cost.</div>
      <div class="footer">Replace logo.png to brand the page.</div>
    </div>

  </div>
</div>

<script>
/* config */
const LOT_BASE = 10000; // mini
const SCALE = LOT_BASE / 100000; // 0.1
let APPS_SCRIPT_URL = ""; // optional. can be filled in settings.

/* pip defaults per 100k */
const DEFAULTS = {
  "EURUSD": 10.0, "GBPUSD": 10.0, "AUDUSD": 10.0, "NZDUSD": 10.0,
  "USDJPY": 9.09, "USDCAD": 10.0, "USDCHF": 10.0,
  "EURGBP": 10.0, "EURJPY": 9.09, "GBPJPY": 9.09,
  "XAUUSD": 1.0, "XAGUSD": 0.05, "SPX500": 0.5, "US30": 1.0, "NAS100": 0.2
};

/* ui refs */
const instrument = document.getElementById('instrument');
const acct = document.getElementById('acct');
const risk = document.getElementById('risk');
const pips = document.getElementById('pips');
const spread = document.getElementById('spread');
const slippage = document.getElementById('slippage');
const acctCurrency = document.getElementById('acctCurrency');
const convWrap = document.getElementById('convWrap');
const convRateEl = document.getElementById('convRate');
const settingsToggle = document.getElementById('settingsToggle');
const settings = document.getElementById('settings');
const appsUrlEl = document.getElementById('appsUrl');
const saveToSheetEl = document.getElementById('saveToSheet');
const calcBtn = document.getElementById('calcBtn');
const out = document.getElementById('resultText');
const warn = document.getElementById('warn');

settingsToggle.addEventListener('click', ()=>{
  settings.classList.toggle('hidden');
});

acctCurrency.addEventListener('change', ()=>{
  if(acctCurrency.value === 'OTHER'){
    convWrap.classList.remove('hidden');
  } else {
    convWrap.classList.add('hidden');
  }
});

/* helpers */
function fmt(x, digits=4){ return typeof x === 'number' ? x.toLocaleString(undefined,{maximumFractionDigits:digits}) : x; }
function setError(el,msg){ let s=el.nextElementSibling; if(s && s.classList && s.classList.contains('err')) s.textContent=msg; else { s=document.createElement('div'); s.className='err'; s.style.color='#b00'; s.style.marginTop='6px'; s.textContent=msg; el.parentNode.insertBefore(s, el.nextSibling);} }
function clearError(el){ let s=el.nextElementSibling; if(s && s.classList && s.classList.contains('err')) s.remove(); }

/* validation */
function validate(){
  let ok=true;
  [acct,risk,pips,spread,slippage].forEach(el=>clearError(el));
  if(!acct.value || Number(acct.value) <= 0){ setError(acct,'Enter account > 0'); ok=false; }
  if(!risk.value || Number(risk.value) <= 0 || Number(risk.value) > 100){ setError(risk,'Enter risk% 0.01–100'); ok=false; }
  if(!pips.value || Number(pips.value) <= 0){ setError(pips,'Enter stop > 0'); ok=false; }
  return ok;
}

/* detect quote currency for an instrument */
function quoteCurrencyFor(instr){
  // common pattern: last 3 characters are currency (e.g. EURUSD -> USD). For indices/metals, default to USD.
  const instrUpper = instr.toUpperCase();
  const last3 = instrUpper.slice(-3);
  const currencies = ['USD','EUR','GBP','JPY','CAD','CHF','AUD','NZD','ZAR'];
  if(currencies.includes(last3)) return last3;
  // fallback mapping
  const map = {'XAUUSD':'USD','XAGUSD':'USD','SPX500':'USD','US30':'USD','NAS100':'USD'};
  return map[instrUpper] || 'USD';
}

/* fetch conversion using exchangerate.host */
async function fetchRate(fromCurr, toCurr){
  if(!fromCurr || !toCurr || fromCurr === toCurr) return 1;
  try{
    const url = `https://api.exchangerate.host/convert?from=${encodeURIComponent(fromCurr)}&to=${encodeURIComponent(toCurr)}&amount=1`;
    const r = await fetch(url);
    if(!r.ok) throw new Error('network');
    const j = await r.json();
    if(j && typeof j.result === 'number') return j.result;
    return null;
  }catch(e){
    console.warn('fx fetch failed', e);
    return null;
  }
}

/* calc logic (real-world adjustments) */
function pipValuePerMini(instr){
  const base = DEFAULTS[instr] || 0;
  return base * SCALE;
}

function positionSize(account, riskPercent, stopPips, pipValue){
  const riskAmount = Number((account * (riskPercent/100)).toFixed(2));
  const costPerLot = Number((stopPips * pipValue).toFixed(8));
  const lots = costPerLot === 0 ? 0 : Number((riskAmount / costPerLot).toFixed(4));
  return { riskAmount, costPerLot, recommendedLots: lots };
}

/* save to google sheet */
async function saveToSheet(payload){
  const url = (appsUrlEl.value && appsUrlEl.value.trim()) || APPS_SCRIPT_URL;
  if(!url) return {ok:false, error:'no url configured'};
  try{
    const res = await fetch(url, {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
    if(!res.ok) throw new Error('network');
    const json = await res.json();
    return {ok:true, json};
  }catch(e){
    console.warn('save error', e);
    return {ok:false, error: e.message};
  }
}

/* main calculate */
async function calculate(){
  warn.style.display='none';
  if(!validate()) return;
  const acctVal = Number(acct.value);
  const riskVal = Number(risk.value);
  const stopVal = Number(pips.value);
  const spreadVal = Number(spread.value) || 0;
  const slipVal = Number(slippage.value) || 0;
  const instr = instrument.value;
  const acctCurr = acctCurrency.value;

  // pip value per mini in instrument quote currency
  let pipVal = pipValuePerMini(instr);
  if(pipVal === 0){ out.innerHTML='Unknown instrument pip value'; return; }

  // detect quote currency
  const quote = quoteCurrencyFor(instr);

  // attempt auto FX conversion when needed
  let convertedPipVal = pipVal;
  if(acctCurr !== quote){
    // try auto fetch
    const rate = await fetchRate(quote, acctCurr);
    if(rate && typeof rate === 'number'){
      convertedPipVal = pipVal * rate;
      convWrap.classList.add('hidden');
    } else {
      // fallback to manual convRate if provided
      const manual = Number(convRateEl.value);
      if(manual && manual > 0){
        convertedPipVal = pipVal * manual;
        convWrap.classList.add('hidden');
      } else {
        // show conv input if auto failed
        convWrap.classList.remove('hidden');
        setError(convRateEl,'Auto FX failed — enter conversion rate or try again.');
        return;
      }
    }
  }

  // include spread and slippage into effective stop
  const effectiveStop = stopVal + spreadVal + slipVal;

  const res = positionSize(acctVal, riskVal, effectiveStop, convertedPipVal);

  out.innerHTML = `Risk: <strong>${fmt(res.riskAmount,2)}</strong><br>Cost/lot: <strong>${fmt(res.costPerLot,4)}</strong><br>Lots: <strong>${fmt(res.recommendedLots,4)}</strong>`;

  if(riskVal > 5) warn.style.display='block';

  if(saveToSheetEl.checked){
    const payload = {
      timestamp: new Date().toISOString(),
      instrument: instr,
      account: acctVal,
      accountCurrency: acctCurr,
      riskPercent: riskVal,
      stopPips: stopVal,
      spreadPips: spreadVal,
      slippagePips: slipVal,
      effectiveStop: effectiveStop,
      pipValueUsed: convertedPipVal,
      riskAmount: res.riskAmount,
      costPerLot: res.costPerLot,
      recommendedLots: res.recommendedLots
    };
    const saved = await saveToSheet(payload);
    if(saved.ok){
      out.innerHTML += `<div class="small" style="margin-top:8px;color:green">Saved to sheet.</div>`;
    } else {
      out.innerHTML += `<div class="small" style="margin-top:8px;color:#b00">Save failed: ${saved.error}</div>`;
    }
  }
}

/* hook events */
calcBtn.addEventListener('click', calculate);
['acct','risk','pips','spread','slippage','convRate'].forEach(id=>{
  const el = document.getElementById(id);
  if(el) el.addEventListener('input', ()=> { clearError(el); document.getElementById('warn').style.display='none'; });
});
</script>
</body>
</html>
