<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Velor — Position Size Calculator</title>
<style>
:root{
  --navy:#07203a; --muted:#6d6d6d; --card:#ffffff; --bg:#f6fbff;
  --radius:10px; --shadow: 0 8px 26px rgba(8,20,40,0.08);
}
body{font-family:Inter,system-ui,Arial,Helvetica,sans-serif;background:var(--bg);margin:18px;color:var(--navy)}
.wrap{max-width:920px;margin:0 auto}
.card{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);padding:14px;margin-bottom:12px}
.top{display:flex;gap:12px;align-items:center}
.logo img{height:48px}
.brand-title{font-weight:700;font-size:18px;color:var(--navy)}
.brand-sub{font-size:13px;color:var(--muted)}
.grid-2{display:grid;grid-template-columns:1fr 340px;gap:14px}
@media (max-width:720px){ .grid-2{grid-template-columns:1fr} }
label{display:block;font-size:13px;color:var(--muted);margin-top:8px}
input, select{width:100%;padding:12px;border-radius:10px;border:1px solid #eef3f6;margin-top:6px;font-size:15px;background:white}
.row{display:flex;gap:10px}
.col{flex:1}
.btn{display:inline-block;padding:12px;border-radius:10px;border:0;background:var(--navy);color:white;font-weight:700;width:100%;font-size:15px;margin-top:12px}
.btn.secondary{background:transparent;color:var(--navy);border:1px solid #e6eef6}
.out{margin-top:12px;padding:12px;border-radius:8px;background:#fbfbfc;border:1px solid #eef3f6;font-weight:600}
.small{font-size:13px;color:var(--muted)}
.toast{position:fixed;left:50%;transform:translateX(-50%);bottom:24px;background:#07203a;color:white;padding:10px 14px;border-radius:8px;display:none}
</style>
</head>
<body>
<div class="wrap">
  <div class="card top">
    <div class="logo"><img src="logo.png" alt="Velor logo"></div>
    <div style="flex:1">
      <div class="brand-title">Velor — Risk Calculator</div>
      <div class="brand-sub">Fast. Mobile-ready.</div>
    </div>
  </div>

  <div class="card grid-2">
    <div>
      <label>Account size (USD)</label>
      <input id="account" type="number" value="10000" min="0" step="1" inputmode="numeric">

      <label>Risk (%)</label>
      <input id="risk" type="number" value="1" min="0" step="0.1" inputmode="decimal">

      <label>Stop (pips)</label>
      <input id="pips" type="number" value="50" min="0" step="1" inputmode="numeric">

      <label>Pair (e.g. EURUSD)</label>
      <input id="pair" type="text" value="EURUSD" inputmode="text">

      <label>Leverage (optional)</label>
      <input id="leverage" type="number" value="100" min="1" step="1" inputmode="numeric">

      <button id="calc" class="btn">Calculate</button>
      <button id="save" class="btn secondary" style="margin-top:8px">Save to Sheet</button>

      <div id="out" class="out" style="display:none"></div>
      <div id="note" class="small" style="margin-top:8px"></div>
    </div>

    <div>
      <div class="small">Quick info</div>
      <div style="margin-top:10px" class="small">Lot size is in standard lots. Micro = 0.01, Mini = 0.10, Standard = 1.00.</div>

      <div style="margin-top:18px">
        <div class="small">API / sheet</div>
        <div class="small" id="api-note" style="margin-top:8px;color:var(--muted)">Saves use the configured Apps Script endpoint.</div>
      </div>
    </div>
  </div>
</div>

<div id="toast" class="toast"></div>

<script>
/* CONFIG */
const APPS_SCRIPT_URL = (typeof APPS_SCRIPT_URL !== 'undefined') ? APPS_SCRIPT_URL : ''; // keep as configured

/* USER ID (for tracking unique users) */
(function ensureUserId(){
  try{
    if(!localStorage.getItem('velor_uid')){
      const id = 'u_'+Date.now()+'_'+Math.random().toString(36).slice(2,8);
      localStorage.setItem('velor_uid', id);
    }
  }catch(e){}
})();

/* CORE */
function positionSize(account, riskPercent, stopPips, pipValue=10){
  const riskAmount = Number((account * (riskPercent/100)).toFixed(2));
  const costPerLot = Number((stopPips * pipValue).toFixed(2));
  const lots = costPerLot === 0 ? 0 : Number((riskAmount / costPerLot).toFixed(2)); // 2 decimals as requested
  return { riskAmount, costPerLot, recommendedLots: lots };
}

function formatNumber(x){ return typeof x === 'number' ? x.toLocaleString(undefined,{maximumFractionDigits:2}) : x; }

function showResult(obj){
  const out = document.getElementById('out');
  out.style.display = 'block';
  out.innerHTML = `Risk amount: <strong>${formatNumber(obj.riskAmount)}</strong><br>
  Stop cost per lot: <strong>${formatNumber(obj.costPerLot)}</strong><br>
  Recommended lots: <strong>${Number(obj.recommendedLots).toFixed(2)}</strong>`;
}

function showToast(msg, t=2200){
  const toast = document.getElementById('toast');
  toast.textContent = msg;
  toast.style.display = 'block';
  setTimeout(()=>{ toast.style.display = 'none'; }, t);
}

async function saveToSheet(payload){
  if(!APPS_SCRIPT_URL) return {ok:false, error:'no endpoint configured'};
  try{
    const res = await fetch(APPS_SCRIPT_URL, {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify(payload)
    });
    const json = await res.json().catch(()=>({}));
    if(!res.ok) return {ok:false, error: json.error || 'http:'+res.status};
    return {ok:true, json};
  }catch(err){
    return {ok:false, error:err.message};
  }
}

/* EVENTS */
document.getElementById('calc').addEventListener('click', ()=>{
  const account = Number(document.getElementById('account').value) || 0;
  const risk = Number(document.getElementById('risk').value) || 0;
  const pips = Number(document.getElementById('pips').value) || 0;
  const pair = (document.getElementById('pair').value || 'EURUSD').toUpperCase();

  // simple pip value assumptions (USD-quoted)
  let pipValue = 10;
  if(pair.endsWith('JPY')) pipValue = 0.9;

  const res = positionSize(account, risk, pips, pipValue);
  showResult(res);
  showToast('Calculated');
});

document.getElementById('save').addEventListener('click', async ()=>{
  const account = Number(document.getElementById('account').value) || 0;
  const risk = Number(document.getElementById('risk').value) || 0;
  const pips = Number(document.getElementById('pips').value) || 0;
  const pair = (document.getElementById('pair').value || 'EURUSD').toUpperCase();
  let pipValue = 10;
  if(pair.endsWith('JPY')) pipValue = 0.9;
  const res = positionSize(account, risk, pips, pipValue);

  const payload = {
    timestamp: new Date().toISOString(),
    pair, account, riskPercent: risk, stopPips: pips,
    pipValue: pipValue, riskAmount: res.riskAmount,
    lotSize: Number(res.recommendedLots),
    userId: localStorage.getItem('velor_uid') || ''
  };

  const note = document.getElementById('note');
  note.textContent = 'saving...';
  const r = await saveToSheet(payload);
  if(r.ok){
    note.textContent = 'saved';
    showToast('Saved');
  }else{
    note.textContent = 'save failed: ' + (r.error || 'unknown');
    showToast('Save failed');
  }
});
</script>
</body>
</html>
